<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <script src="https://www.gstatic.com/external_hosted/omnitone/build/omnitone.min.js"></script>
    <title>Document</title>
  </head>
  <body>
    <h1>
      EigenScape First Order Ambisonic Renderer
    </h1>
    <p>
      <code>FOARenderer</code> is an optimized ambisonic renderer based on the
      integrated convolution (SH-MaxRe HRIR). This Example file has been
      modified to serve audio from the EigenScape dataset.
    </p>
    <p>
      See <a href="https://github.com/GoogleChrome/omnitone#foarenderer">more
      info</a> on <code>FOARenderer</code>.
      See <a href="https://zenodo.org/record/1012809">more
      info</a> on <code>EigenScape Dataset</code>.
    </p>
    <div id="secSource">
      <p>
        NOTE: Use headphones for the full-sphere surround sound.
      </p><select id="eSelectSource" name="dropdownSource" disabled>
        <option value="Beach" selected="selected">
          Beach
        </option>
        <option value="Park">
          Park
        </option>
      </select> <button id="eButtonPlayback" disabled>Play</button>
    </div>
    <div id="secRenderingMode">
      <span class="label">Rendering mode</span> <button id="eButtonBypass"
      disabled>Ambisonic</button>
    </div>
    <div id="footer">
      <p>
        Found something broken? <a href=
        "https://github.com/GoogleChrome/omnitone/issues">File an issue.</a>
      </p>
    </div>
    <dl>
        <dt>
          Azimuth = <span id="eLabelAzimuth">0</span>
        </dt>
        <dd>
          <input oninput="rotateScene(this);" id="eRangeAzimuth" type="range"
          min="-180" max="180" value="0" step="1">
        </dd>
        <dt>
          Elevation = <span id="eLabelElevation">0</span>
        </dt>
        <dd>
          <input oninput="rotateScene(this);" id="eRangeElevation" type="range"
          min="-90" max="90" value="0" step="1">
        </dd>
        <dt>
          Gain (dB) = <span id="eLabelGain">0</span>
        </dt>
        <dd>
          <input oninput="adjustGain(this);" id="eRangeGain" type="range" min=
          "-60" max="24" value="0" step="1">
        </dd>
      </dl>
    <script>
    var foaRenderer;
    var audioSources = {
      'Beach': 'Beach.1.1.wav',
      'Park': 'Park.3.3.wav'
    };
    var buttonPlayback, selectSource, buttonBypass;
    var rotationMatrix3 = new Float32Array(9);
    var onLoad = function () {
      var audioContext = new AudioContext();
      var audioElement = document.createElement('audio');
      var audioElementSource =
          audioContext.createMediaElementSource(audioElement);
      audioElement.loop = true;
      audioElement.crossOrigin = 'anonymous';
      audioElement.src = audioSources['Beach'];
      eRangeGain.oninput = onGainSliderChange;
      eRangeAzimuth.oninput = onDirectionChange;
      eRangeElevation.oninput = onDirectionChange;
      foaRenderer = Omnitone.createFOARenderer(audioContext, {
        // The example audio is in the FuMa ordering (W,X,Y,Z). So remap the
        // channels to the ACN format.
        // channelMap: [0, 3, 1, 2]
        channelMap: [0, 1, 2, 3]
      });

      selectSource = document.getElementById('eSelectSource');
      buttonPlayback = document.getElementById('eButtonPlayback');
      buttonBypass = document.getElementById('eButtonBypass');

      selectSource.onchange = function (event) {
        audioElement.src = audioSources[event.target.value];
        audioElement.load();
        if (buttonPlayback.textContent === 'Pause')
          audioElement.play();
      };

      buttonPlayback.onclick = function (event) {
        if (event.target.textContent === 'Play') {
          event.target.textContent = 'Pause';
          audioContext.resume();
          audioElement.play();
        } else {
          event.target.textContent = 'Play';
          audioElement.pause();
          audioContext.suspend();
        }
      };

      buttonBypass.onclick = function (event) {
        if (event.target.textContent === 'Ambisonic') {
          event.target.textContent = 'Bypass';
          foaRenderer.setRenderingMode('bypass');
        } else {
          event.target.textContent = 'Ambisonic';
          foaRenderer.setRenderingMode('ambisonic');
        }
      };

      foaRenderer.initialize().then(function () {
        selectSource.disabled = false;
        buttonPlayback.disabled = false;
        buttonBypass.disabled = false;
        audioElementSource.connect(foaRenderer.input);
        foaRenderer.output.connect(audioContext.destination);
      }, function (onInitializationError) {
        console.error(onInitializationError);
      });
    };
    function crossProduct(a, b) {
        return [
          a[1] * b[2] - a[2] * b[1],
          a[2] * b[0] - a[0] * b[2],
          a[0] * b[1] - a[1] * b[0]
        ];
      }

       function normalize(a) {
         var n = Math.sqrt(a[0] * a[0] + a[1] * a[1] + a[2] * a[2]);
         a[0] /= n;
         a[1] /= n;
         a[2] /= n;
         return a;
       }

      function onDirectionChange() {
        // if (!exampleInitialized)
        //   return;

        var azimuthValue =
            parseFloat(document.getElementById('eRangeAzimuth').value);
        var elevationValue =
            parseFloat(document.getElementById('eRangeElevation').value);
        document.getElementById('eLabelAzimuth').textContent = azimuthValue;
        document.getElementById('eLabelElevation').textContent = elevationValue;

        // Standard OpenGL-style "View" Matrix calculation.
        var theta = azimuthValue / 180 * Math.PI;
        var phi = elevationValue / 180 * Math.PI;
        var forward = [
          Math.sin(theta) * Math.cos(phi),
          Math.sin(phi),
          Math.cos(theta) * Math.cos(phi)
        ];
        var upInitial = [0, 1, 0];
        var right = normalize(crossProduct(forward, upInitial));
        var up = normalize(crossProduct(right, forward));
        rotationMatrix3[0] = right[0];
        rotationMatrix3[1] = right[1];
        rotationMatrix3[2] = right[2];
        rotationMatrix3[3] = up[0];
        rotationMatrix3[4] = up[1];
        rotationMatrix3[5] = up[2];
        rotationMatrix3[6] = forward[0];
        rotationMatrix3[7] = forward[1];
        rotationMatrix3[8] = forward[2];
        foaRenderer.setRotationMatrix3(rotationMatrix3);
      }

      function onGainSliderChange() {
        if (!exampleInitialized)
          return;

        document.getElementById('eLabelGain').textContent = eRangeGain.value;
        inputGain.gain.value = Math.pow(10, parseFloat(eRangeGain.value) / 20);
      }
    window.addEventListener('load', onLoad);
    </script>
  </body>
</html>
