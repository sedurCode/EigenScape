<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <script src="https://www.gstatic.com/external_hosted/omnitone/build/omnitone.min.js"></script>
    <title>Document</title>
  </head>
  <body>
    <h2>
        Orient the head by selecting the horizontal and vertical controls.
      </h2>
      <dl>
        <dt>
          Azimuth = <span id="eLabelAzimuth">0</span>
        </dt>
        <dd>
          <input oninput="rotateScene(this);" id="eRangeAzimuth" type="range"
          min="-180" max="180" value="0" step="1">
        </dd>
        <dt>
          Elevation = <span id="eLabelElevation">0</span>
        </dt>
        <dd>
          <input oninput="rotateScene(this);" id="eRangeElevation" type="range"
          min="-90" max="90" value="0" step="1">
        </dd>
        <dt>
          Gain (dB) = <span id="eLabelGain">0</span>
        </dt>
        <dd>
          <input oninput="adjustGain(this);" id="eRangeGain" type="range" min=
          "-60" max="24" value="0" step="1">
        </dd>
      </dl>
    <button id="play">play</button>
    <button id="stop">stop</button>
    <script>
    // //<!-- // `Omnitone` object is loaded and ready. -->
    // //<!-- var audioContext = new AudioContext();
    // // var foaRenderer = Omnitone.createFOARenderer(audioContext);
    // // import omnitone from '../node_modules/omnitone/build/omnitone.min.esm.js';
    // <!-- // Set up an audio element to feed the ambisonic source audio feed. -->
    // const audioElement = document.createElement('audio');
    // audioElement.src = 'Beach.1.1.wav';
    //
    // <!-- // Create AudioContext, MediaElementSourceNode and FOARenderer. -->
    // const audioContext = new AudioContext();
    // const audioElementSource = audioContext.createMediaElementSource(audioElement);
    // const foaRenderer = Omnitone.createFOARenderer(audioContext);
    //
    // <!-- // Make connection and start play. Hook up the user input for the playback. -->
    // foaRenderer.initialize().then(function() {
    //   audioElementSource.connect(foaRenderer.input);
    //   foaRenderer.output.connect(audioContext.destination);
    //
    //   <!-- // This is necessary to activate audio playback out of autoplay block. -->
    //   playButton = document.getElementById("play");
    //   playButton.onclick = () => {
    //     audioContext.resume();
    //     audioElement.play();
    //     console.log('playing');
    //   };
    //   <!-- // This is necessary to activate audio playback out of autoplay block. -->
    //   stopButton = document.getElementById("stop");
    //   stopButton.onclick = () => {
    //     audioElement.pause();
    //     audioContext.suspend();
    //     console.log('playing');
    //   };
    // });
    //   // document.getElementById('geolocate').addEventListener('click', event => {
    //   //   if ('geolocation' in navigator) {
    //   //     console.log('geolocation available');
    //   //     navigator.geolocation.getCurrentPosition(position => {
    //   //       lat = position.coords.latitude;
    //   //       lon = position.coords.longitude;
    //   //       console.log(lat, lon);
    //   //       document.getElementById('latitude').textContent = lat;
    //   //       document.getElementById('longitude').textContent = lon;
    //   //     });
    //   //   } else {
    //   //     console.log('geolocation not available');
    //   //   }
    //   // });
    //   function crossProduct(a, b) {
    //     return [
    //       a[1] * b[2] - a[2] * b[1],
    //       a[2] * b[0] - a[0] * b[2],
    //       a[0] * b[1] - a[1] * b[0]
    //     ];
    //   }
    //
    //    function normalize(a) {
    //      var n = Math.sqrt(a[0] * a[0] + a[1] * a[1] + a[2] * a[2]);
    //      a[0] /= n;
    //      a[1] /= n;
    //      a[2] /= n;
    //      return a;
    //    }
    (function () {

      'use strict';

      var exampleInitialized = false;

      var audioContext;
      var toaRenderer;
      var soaRenderer;
      var currentBufferSource;
      var inputGain;
      var contentBuffer;
      var rotationMatrix3 = new Float32Array(9);

      var eButtonPlayback;
      var eButtonAmbisonicOrder;
      var eRangeAzimuth;
      var eRangeElevation;
      var eRangeGain;

      var exampleSoundPathList = [
        'Beach.1.1.wav',
        'Park.3.3.wav'
      ];

      function crossProduct(a, b) {
        return [
          a[1] * b[2] - a[2] * b[1],
          a[2] * b[0] - a[0] * b[2],
          a[0] * b[1] - a[1] * b[0]
        ];
      }

       function normalize(a) {
         var n = Math.sqrt(a[0] * a[0] + a[1] * a[1] + a[2] * a[2]);
         a[0] /= n;
         a[1] /= n;
         a[2] /= n;
         return a;
       }

      function onDirectionChange() {
        if (!exampleInitialized)
          return;

        var azimuthValue =
            parseFloat(document.getElementById('eRangeAzimuth').value);
        var elevationValue =
            parseFloat(document.getElementById('eRangeElevation').value);
        document.getElementById('eLabelAzimuth').textContent = azimuthValue;
        document.getElementById('eLabelElevation').textContent = elevationValue;

        // Standard OpenGL-style "View" Matrix calculation.
        var theta = azimuthValue / 180 * Math.PI;
        var phi = elevationValue / 180 * Math.PI;
        var forward = [
          Math.sin(theta) * Math.cos(phi),
          Math.sin(phi),
          Math.cos(theta) * Math.cos(phi)
        ];
        var upInitial = [0, 1, 0];
        var right = normalize(crossProduct(forward, upInitial));
        var up = normalize(crossProduct(right, forward));

        rotationMatrix3[0] = right[0];
        rotationMatrix3[1] = right[1];
        rotationMatrix3[2] = right[2];
        rotationMatrix3[3] = up[0];
        rotationMatrix3[4] = up[1];
        rotationMatrix3[5] = up[2];
        rotationMatrix3[6] = forward[0];
        rotationMatrix3[7] = forward[1];
        rotationMatrix3[8] = forward[2];

        eButtonAmbisonicOrder.textContent === '3rd Order'
            ? toaRenderer.setRotationMatrix3(rotationMatrix3)
            : soaRenderer.setRotationMatrix3(rotationMatrix3);
      }

      function onGainSliderChange() {
        if (!exampleInitialized)
          return;

        document.getElementById('eLabelGain').textContent = eRangeGain.value;
        inputGain.gain.value = Math.pow(10, parseFloat(eRangeGain.value) / 20);
      }

      function onTogglePlayback(event) {
        if (!exampleInitialized)
          return;

        switch (event.target.textContent) {
          case 'Play':
            currentBufferSource = audioContext.createBufferSource();
            currentBufferSource.buffer = contentBuffer;
            currentBufferSource.loop = true;
            currentBufferSource.connect(inputGain);
            currentBufferSource.start();
            event.target.textContent = 'Stop';
            break;
          case 'Stop':
            currentBufferSource.stop();
            currentBufferSource.disconnect();
            event.target.textContent = 'Play';
            break;
        }
      }

      function onToggleAmbisonicOrder(event) {
        if (!exampleInitialized)
          return;

        switch (event.target.textContent) {
          case '3rd Order':
            toaRenderer.setRenderingMode('off');
            soaRenderer.setRenderingMode('ambisonic');
            soaRenderer.setRotationMatrix3(rotationMatrix3);
            event.target.textContent = '2nd Order';
            break;
          case '2nd Order':
            soaRenderer.setRenderingMode('off');
            toaRenderer.setRenderingMode('ambisonic');
            toaRenderer.setRotationMatrix3(rotationMatrix3);
            event.target.textContent = '3rd Order';
            break;
        }
      }

      function onLoad() {
        eButtonPlayback = document.getElementById('eButtonPlayback');
        eButtonAmbisonicOrder =
            document.getElementById('eButtonAmbisonicOrder');
        eRangeAzimuth = document.getElementById('eRangeAzimuth');
        eRangeElevation = document.getElementById('eRangeElevation');
        eRangeGain = document.getElementById('eRangeGain');

        eButtonPlayback.onclick = onTogglePlayback;
        eButtonAmbisonicOrder.onclick = onToggleAmbisonicOrder;
        eRangeGain.oninput = onGainSliderChange;
        eRangeAzimuth.oninput = onDirectionChange;
        eRangeElevation.oninput = onDirectionChange;

        audioContext = new AudioContext();
        inputGain = audioContext.createGain();
        toaRenderer = Omnitone.createHOARenderer(audioContext);
        soaRenderer = Omnitone.createHOARenderer(audioContext,
                                                 {ambisonicOrder: 2});

        Promise.all([
          Omnitone.createBufferList(audioContext, exampleSoundPathList),
          toaRenderer.initialize(),
          soaRenderer.initialize()
          ]).then((results) => {
            contentBuffer =
                Omnitone.mergeBufferListByChannel(audioContext, results[0]);
            inputGain.connect(soaRenderer.input);
            inputGain.connect(toaRenderer.input);
            soaRenderer.output.connect(audioContext.destination);
            toaRenderer.output.connect(audioContext.destination);
            soaRenderer.setRenderingMode('off');
            eButtonPlayback.disabled = false;
            eButtonAmbisonicOrder.disabled = false;
            exampleInitialized = true;
          });
      }

      window.addEventListener('load', onLoad);
    })();
    </script>
  </body>
</html>
